//толик

Процедура ПередЗаписью(Отказ, Замещение, ТолькоЗапись,ЗаписьФактическогоПериодаДействия, ЗаписьПерерасчетов) 
	//Островская Татьяна 29.10.2013 № 16865
	если ЗначениеЗаполнено(ЭтотОбъект.Отбор) Тогда 
		если ТипЗнч(ЭтотОбъект.Отбор.Регистратор.Значение) = Тип("ДокументСсылка.НачислениеЗарплатыРаботникамОрганизаций") Тогда 
			ФлагДоговора = ЭтотОбъект.Отбор.Регистратор.Значение.ТЧДоговораРекв;
		иначе
			ФлагДоговора = Ложь;
		КонецЕсли;
	КонецЕсли;
	//Островская Татьяна 29.10.2013 № 16865
	Для Каждого СтрокаНабора Из ЭтотОбъект Цикл 
		//Островская Татьяна 29.10.2013 № 16865
		ЗапросСотрудник = Новый Запрос;
		
		ЗапросСотрудник.Текст = 
		"ВЫБРАТЬ
		|	СотрудникиОрганизаций.Ссылка,
		|	СотрудникиОрганизаций.Код,
		|	ВложенныйЗапрос.Период КАК Период
		|ИЗ
		|	Справочник.СотрудникиОрганизаций КАК СотрудникиОрганизаций
		|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		|			РаботникиОрганизаций.Сотрудник КАК Сотрудник,
		|			РаботникиОрганизаций.Период КАК Период
		|		ИЗ
		|			РегистрСведений.РаботникиОрганизаций КАК РаботникиОрганизаций
		|		ГДЕ
		|			РаботникиОрганизаций.Регистратор ССЫЛКА Документ.УвольнениеИзОрганизаций) КАК ВложенныйЗапрос
		|		ПО СотрудникиОрганизаций.Ссылка = ВложенныйЗапрос.Сотрудник
		|ГДЕ
		|	СотрудникиОрганизаций.Физлицо = &Физлицо
		|	//И СотрудникиОрганизаций.ВидДоговора = &ВидДоговора
		|
		|УПОРЯДОЧИТЬ ПО
		|	Период"; //О.Т. 13.08.2014 
		Если ФлагДоговора Тогда
			ЗапросСотрудник.Текст = СтрЗаменить(ЗапросСотрудник.Текст,"//И СотрудникиОрганизаций.ВидДоговора = &ВидДоговора","И СотрудникиОрганизаций.ВидДоговора = &ВидДоговора" );
		иначе
			ЗапросСотрудник.Текст = СтрЗаменить(ЗапросСотрудник.Текст,"//И СотрудникиОрганизаций.ВидДоговора = &ВидДоговора","И НЕ СотрудникиОрганизаций.ВидДоговора = &ВидДоговора" );
		КонецЕсли;
		ЗапросСотрудник.УстановитьПараметр("Физлицо",СтрокаНабора.ФизЛицо);
		ЗапросСотрудник.УстановитьПараметр("ВидДоговора",Перечисления.ВидыДоговоровСФизЛицами.Подряда);
		РезультСотрудник = ЗапросСотрудник.Выполнить().Выбрать(); 
		если РезультСотрудник.Следующий() Тогда 
			мСотрудник = РезультСотрудник.Ссылка;
		иначе
			//О.Т. 16.09.2014 № 226
			если не ФлагДоговора Тогда 
				ЗапросСотрудник.Текст = СтрЗаменить(ЗапросСотрудник.Текст,"И НЕ СотрудникиОрганизаций.ВидДоговора = &ВидДоговора","И СотрудникиОрганизаций.ВидДоговора = &ВидДоговора" );
			КонецЕсли;
			РезультСотрудник = ЗапросСотрудник.Выполнить().Выбрать();
			если РезультСотрудник.Следующий() Тогда 
				мСотрудник = РезультСотрудник.Ссылка;
			иначе
				мСотрудник = Справочники.СотрудникиОрганизаций.НайтиПоРеквизиту("ФизЛицо", СтрокаНабора.ФизЛицо);
			КонецЕсли;
			//О.Т. 16.09.2014 № 226
		КонецЕсли;
		//Островская Татьяна 04.06.2014 № 17395
		если ЗначениеЗаполнено(СтрокаНабора.Сотрудник) Тогда 
			мСотрудник = СтрокаНабора.Сотрудник;
		КонецЕсли;  //Островская Татьяна 04.06.2014 № 17395
		//Островская Татьяна 29.10.2013 № 16865
		мРаботникиОрганизаций = РегистрыСведений.РаботникиОрганизаций.ПолучитьПоследнее(?(СтрокаНабора.ПериодДействияНачало = '00010101000000',СтрокаНабора.БазовыйПериодНачало,СтрокаНабора.ПериодДействияНачало),  //Аверсон 10.02.2020 КВВ СВФР-005485 (проверка на пустую дату)
		Новый Структура("Организация, Сотрудник", СтрокаНабора.Организация, мСотрудник));
		СтрокаНабора.Сотрудник = мСотрудник;
		Если не ЗначениеЗаполнено(СтрокаНабора.ПодразделениеОрганизации) Тогда 
			СтрокаНабора.ПодразделениеОрганизации = мРаботникиОрганизаций.ПодразделениеОрганизации;
			
			//Аверсон 18.11.2022 КВВ СВФР-009849 (
			Если НЕ ЗначениеЗаполнено(СтрокаНабора.ПодразделениеОрганизации) И
				СтрокаНабора.ВидРасчета = ПланыВидовРасчета.УдержанияОрганизаций.ДополнительнаяПенсия И
				ТипЗнч(ЭтотОбъект.Отбор.Регистратор.Значение) = Тип("ДокументСсылка.НачислениеЗарплатыРаботникамОрганизаций") И
				мСотрудник.ТипРаботника = Перечисления.ТипыРаботников.ДоговорПодряда Тогда
				ЗДП = Новый Запрос;
				ЗДП.Текст = "ВЫБРАТЬ
				|ДоговорНаВыполнениеРаботСФизЛицом.ПодразделениеОрганизации
				|ИЗ Документ.ДоговорНаВыполнениеРаботСФизЛицом КАК ДоговорНаВыполнениеРаботСФизЛицом
				|ГДЕ ДоговорНаВыполнениеРаботСФизЛицом.Сотрудник = &Сотрудник
				|И ДоговорНаВыполнениеРаботСФизЛицом.Проведен = ИСТИНА
				|И &ДатаНачала МЕЖДУ ДоговорНаВыполнениеРаботСФизЛицом.ДатаНачала И ДоговорНаВыполнениеРаботСФизЛицом.ДатаОкончания";
				ЗДП.УстановитьПараметр("Сотрудник",мСотрудник);
				ЗДП.УстановитьПараметр("ДатаНачала",СтрокаНабора.БазовыйПериодНачало);
				РезЗДП = ЗДП.Выполнить().Выгрузить();
				Если РезЗДП.Количество() > 0 Тогда
					СтрокаНабора.ПодразделениеОрганизации = РезЗДП[0].ПодразделениеОрганизации;
				КонецЕсли;
			КонецЕсли;
			//Аверсон 18.11.2022 КВВ СВФР-009849 )
			
		КонецЕсли;
		Если НЕ ЗначениеЗаполнено(СтрокаНабора.ПодразделениеОрганизации) Тогда
			СтрокаНабора.ПодразделениеОрганизации = ЭтотОбъект.Отбор.Регистратор.Значение.ПодразделениеОрганизации;
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры


//енд