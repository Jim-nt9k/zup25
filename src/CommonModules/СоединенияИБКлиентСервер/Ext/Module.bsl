////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ ПРИНУДИТЕЛЬНОГО ОТКЛЮЧЕНИЯ СЕАНСОВ ИБ

// Отключает сеанс по номеру сеанса
//
// Параметры
//  ПараметрыАдминистрированияИБ  – Структура – параметры администрирования ИБ
//  НомерСеанса - Число - номер сеанса для отключения
// 
// Возвращаемое значение:
//  Булево – результат отключения сеанса.
//
Функция ОтключитьСеанс(НомерСеанса, Сообщение) Экспорт
	
	Если СоединенияИБ.КоличествоСеансовИнформационнойБазы(Ложь) <= 1 Тогда
		Возврат Истина; // Отключены все пользователи, кроме текущего сеанса
	КонецЕсли;
	
	// Невозможно принудительно отсоединить сеансы в файловом режиме работы
	Если ИнформационнаяБазаФайловая() Тогда
 		СоединенияИБ.ЗаписатьНазванияСоединенийИБ(НСтр("Невозможно принудительно отсоединить сеанс в файловом режиме работы"));
		Возврат Ложь; 
	КонецЕсли;
	
#Если НаКлиенте Тогда		
	Если ОбщегоНазначенияКлиент.КлиентПодключенЧерезВебСервер() Тогда
		Если СоединенияИБПовтИсп.ПараметрыОтключенияСеансов().WindowsПлатформаНаСервере Тогда
			// Передаем управление на сервер
			Возврат СоединенияИБ.ОтключитьСеанс(НомерСеанса, Сообщение);
		КонецЕсли;
 		СоединенияИБ.ЗаписатьНазванияСоединенийИБ(НСтр("Невозможно принудительно отсоединить сеанс при работе с клиента через веб-сервер,
			| если на сервере не установлена ОС Microsoft Windows"));
		Возврат Ложь; 
	КонецЕсли;
#КонецЕсли		
	
	Попытка
		Возврат ЗавершитьСеанс(СоединенияИБПовтИсп.ПолучитьПараметрыАдминистрированияИБ(), НомерСеанса);
	Исключение
		Сообщение = НСтр("ru = 'Сеанс не завершен. Причина отказа в Журнале регистрации.'");
		ЗаписатьСобытие(ПодробноеПредставлениеОшибки(ИнформацияОбОшибке()), "Ошибка");
		Возврат Ложь;
	КонецПопытки;

	
КонецФункции

Функция ЗавершитьСеанс(ПараметрыСоединенияССервером1СПредприятие, Знач НомерСеансаДляЗавершения)
	
	Результат = Новый Структура("СоединениеСРабочимПроцессом, Соединения", Неопределено, Новый Массив);
	
	Если ИнформационнаяБазаФайловая() Тогда
		ВызватьИсключение НСтр("ru = 'Невозможно получить список активных соединений в файловом режиме работы'");
	КонецЕсли;
	
#Если НаКлиенте Тогда		
	Если ОбщегоНазначенияКлиент.КлиентПодключенЧерезВебСервер() Тогда
		ВызватьИсключение НСтр("ru = 'Невозможно получить список активных соединений при работе через веб-сервер'");
	КонецЕсли;
#КонецЕсли		
	
	ПодстрокиСтрокиСоединения = СтроковыеФункцииКлиентСервер.РазложитьСтрокуВМассивПодстрок(
		СтрокаСоединенияИнформационнойБазы(), ";");
	
	ИмяСервера = СтроковыеФункцииКлиентСервер.СократитьДвойныеКавычки(Сред(ПодстрокиСтрокиСоединения[0], 7));
	ИмяИБ      = СтроковыеФункцииКлиентСервер.СократитьДвойныеКавычки(Сред(ПодстрокиСтрокиСоединения[1], 6));
	
	COMСоединитель = Новый COMОбъект(ОбщегоНазначения.ИмяCOMСоединителя());
	
	РазделительПорта = Найти(ИмяСервера, ":");
	Если РазделительПорта > 0 Тогда
		ИмяИПортСервера = ИмяСервера;
		ИмяСервера = Сред(ИмяИПортСервера, 1, РазделительПорта - 1);
		НомерПортаКластера = Число(Сред(ИмяИПортСервера, РазделительПорта + 1));
	ИначеЕсли ПараметрыСоединенияССервером1СПредприятие.ПортКластераСерверов <> 0 Тогда
		НомерПортаКластера = ПараметрыСоединенияССервером1СПредприятие.ПортКластераСерверов;
	Иначе
		НомерПортаКластера = COMСоединитель.RMngrPortDefault;
	КонецЕсли;
	
	ИдентификаторАгентаСервера = ИмяСервера;
	Если ПараметрыСоединенияССервером1СПредприятие.ПортАгентаСервера <> 0 Тогда
	      ИдентификаторАгентаСервера = ИдентификаторАгентаСервера + ":" + 
		  	Формат(ПараметрыСоединенияССервером1СПредприятие.ПортАгентаСервера, "ЧГ=0");
	КонецЕсли;
	
	// Подключение к агенту сервера
	АгентСервера = COMСоединитель.ConnectAgent(ИдентификаторАгентаСервера);
	
	// Найдем необходимый нам кластер
	Для Каждого Кластер Из АгентСервера.GetClusters() Цикл
		
		Если Кластер.MainPort = НомерПортаКластера Тогда
			
			АгентСервера.Authenticate(Кластер,
				ПараметрыСоединенияССервером1СПредприятие.ИмяАдминистратораКластера,
				ПараметрыСоединенияССервером1СПредприятие.ПарольАдминистратораКластера);
			СписокСеансов = АгентСервера.GetSessions(Кластер);
			Для Каждого Сеанс из СписокСеансов Цикл
				Если ВРег(Сеанс.InfoBase.Name) = ВРег(ИмяИБ) Тогда
					Если Сеанс.SessionID = НомерСеансаДляЗавершения Тогда
						АгентСервера.TerminateSession(Кластер, Сеанс);
						Сообщение = СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
								НСтр("ru = 'Разорван сеанс: Пользователь %1, компьютер %2, начат %3, режим %4'"),
								Сеанс.UserName,
								Сеанс.Host,
								Сеанс.StartedAt,
								Сеанс.AppID);
						ЗаписатьСобытие(Сообщение, "Информация");
						Возврат Истина;
					КонецЕсли;
				КонецЕсли;
			КонецЦикла;
			
		КонецЕсли;
		
	КонецЦикла;
	
	Возврат Ложь;
	
КонецФункции


Функция ИнформационнаяБазаФайловая()
#Если НаКлиенте Тогда	
	Результат = СтандартныеПодсистемыКлиентПовтИсп.ПараметрыРаботыКлиента().ИнформационнаяБазаФайловая;
#Иначе
	Результат = ОбщегоНазначения.ИнформационнаяБазаФайловая();
#КонецЕсли		
	Возврат Результат;
КонецФункции

Процедура ЗаписатьСобытие(Знач ТекстСобытия, ПредставлениеУровня = "Информация", Записать = Истина)
#Если НаКлиенте Тогда	
	ОбщегоНазначенияКлиент.ДобавитьСообщениеДляЖурналаРегистрации(СобытиеЖурналаРегистрации(),
		ПредставлениеУровня, ТекстСобытия,,Записать);
#Иначе
	ЗаписьЖурналаРегистрации(СобытиеЖурналаРегистрации(), 
		ПредопределенноеЗначение("УровеньЖурналаРегистрации." + ПредставлениеУровня),,, ТекстСобытия);
#КонецЕсли		
КонецПроцедуры

// Возвращает строковую константу для формирования сообщений журнала регистрации.
//
// Возвращаемое значение:
//   Строка
//
Функция СобытиеЖурналаРегистрации()
	
	Возврат НСтр("ru = 'Завершение работы пользователей'");
	
КонецФункции

// Получить пустую структуру параметров администрирования кластера серверов.
//
// Возвращаемое значение:
//   Структура – с полями:
//     ИмяАдминистратораКластера
//     ПарольАдминистратораКластера
//     ПортКластераСерверов
//     ПортАгентаСервера
//
Функция НовыеПараметрыАдминистрированияИБ(Знач ИмяАдминистратораКластера = "",
	Знач ПарольАдминистратораКластера = "", Знач ПортКластераСерверов = 0, 
	Знач ПортАгентаСервера = 0) Экспорт
	
	Возврат Новый Структура("ИмяАдминистратораКластера,
		|ПарольАдминистратораКластера,
		|ПортКластераСерверов,
		|ПортАгентаСервера",
		ИмяАдминистратораКластера,
		ПарольАдминистратораКластера,
		ПортКластераСерверов,
		ПортАгентаСервера);
	
КонецФункции

