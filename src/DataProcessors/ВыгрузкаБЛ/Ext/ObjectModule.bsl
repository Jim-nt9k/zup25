
Процедура ВыгрузитьДанные() Экспорт
	
	Если Флажок2 И Не ЗначениеЗаполнено(ТекДок) Тогда
		Предупреждение("Для отменяющей формы должен быть выбран конкретный документ!");
	Иначе
		
		З = Новый Запрос;
		З.Текст = "ВЫБРАТЬ 
		|Док.Ссылка КАК Док,    
		|Док.СерияВходящегоДокумента КАК Серия,
		|Док.НомерВходящегоДокумента КАК Номер,
		|Док.ПервичныйБольничныйЛист КАК ПервичныйБЛ,
		|Док.ДатаНачала КАК НачалоБЛ,
		|Док.ДатаОкончания КАК ОкончаниеБЛ, 
		|Док.ПричинаНетрудоспособности КАК Причина,
		|Ложь КАК ПризнакДогПодряда,
		|Док.Сотрудник КАК Сотрудник,
		|Док.Сотрудник.ФизЛицо.СтраховойНомерПФР КАК ЛичныйНомер,
		|ФИОФизЛицСрезПоследних.Фамилия КАК Фамилия,
		|ФИОФизЛицСрезПоследних.Имя КАК Имя,
		|ФИОФизЛицСрезПоследних.Отчество КАК Отчество
		|
		|ИЗ Документ.НачислениеПоБольничномуЛисту КАК Док   
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ФИОФизЛиц.СрезПоследних(&ДатаПо, ) КАК ФИОФизЛицСрезПоследних
		|ПО Док.Сотрудник.ФизЛицо = ФИОФизЛицСрезПоследних.ФизЛицо
		|
		|ГДЕ Док.ПометкаУдаления = ЛОЖЬ
		|И Док.Дата МЕЖДУ &ДатаС и &ДатаПо";
		
		Если Флажок1 И НЕ Флажок2 Тогда
			З.Текст = З.Текст + "
			|И Док.Проведен = ИСТИНА";
		КонецЕсли; 
		
		//КВВ СВФР-012942 (
		Если Флажок3 Тогда
			З.Текст = З.Текст + "
			|И Док.ДокВыгруженНаПортал = ЛОЖЬ";
		КонецЕсли;
		//КВВ СВФР-012942 )
		
		Если ЗначениеЗаполнено(ТекДок) Тогда
			З.Текст = З.Текст + "
			|И Док.Ссылка = &ТекДок";  
		КонецЕсли;
		
		З.Текст = З.Текст + "
		|
		|ОБЪЕДИНИТЬ 
		|
		|ВЫБРАТЬ 
		|Док2.Ссылка, 
		|Док2.СерияВходящегоДокумента,
		|Док2.НомерВходящегоДокумента,
		|Док2.ПервичныйБольничныйЛист,
		|Док2.ДатаНачала,
		|Док2.ДатаОкончания, 
		|Док2.ПричинаНетрудоспособности,
		|Истина,// КАК ПризнакДогПодряда,
		|Док2.Сотрудник,
		|Док2.Сотрудник.ФизЛицо.СтраховойНомерПФР,
		|ФИОФизЛицСрезПоследних2.Фамилия,
		|ФИОФизЛицСрезПоследних2.Имя,
		|ФИОФизЛицСрезПоследних2.Отчество
		|
		|ИЗ Документ.НачислениеПоБольничномуЛистуПоДоговорамПодряда КАК Док2  
		|
		|ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ФИОФизЛиц.СрезПоследних(&ДатаПо, ) КАК ФИОФизЛицСрезПоследних2
		|ПО Док2.Сотрудник.ФизЛицо = ФИОФизЛицСрезПоследних2.ФизЛицо
		|         
		|ГДЕ Док2.ПометкаУдаления = ЛОЖЬ
		|И Док2.Дата МЕЖДУ &ДатаС и &ДатаПо";
		
		Если Флажок1 И НЕ Флажок2 Тогда
			З.Текст = З.Текст + "
			|И Док2.Проведен = ИСТИНА";
		КонецЕсли;
		
		//КВВ СВФР-012942 (
		Если Флажок3 Тогда
			З.Текст = З.Текст + "
			|И Док2.ДокВыгруженНаПортал = ЛОЖЬ";
		КонецЕсли;
		//КВВ СВФР-012942 )
		
		Если ЗначениеЗаполнено(ТекДок) Тогда
			З.Текст = З.Текст + "
			|И Док2.Ссылка = &ТекДок";
		КонецЕсли;  
		З.УстановитьПараметр("ТекДок",ТекДок);
		З.УстановитьПараметр("ДатаС",ДатаС);
		З.УстановитьПараметр("ДатаПо",КонецДня(ДатаПо));
		РезЗ = З.Выполнить().Выгрузить();
		Если РезЗ.Количество() >0 Тогда
			ОргУНП = СокрЛП(Организация.ИНН);
			ОргУНПФСЗН = СокрЛП(Организация.РегистрационныйНомерПФР);
			
			ТекДата = НачалоМинуты(ТекущаяДата());
			//ТекДата = ТекущаяДатаСеанса();		
			
			СчДок = 0;
			Для Каждого Докк ИЗ РезЗ Цикл   
				Если НЕ ЗначениеЗаполнено(СокрЛП(Докк.Серия)) ИЛИ НЕ ЗначениеЗаполнено(СокРЛП(Докк.Номер)) Тогда
					Сообщить("Документ " + СокрЛП(Докк.Док) + " выгружен не будет, т.к. не внесены серия и номер!");
					Продолжить;
				КонецЕсли;
				
				//КВВ СВФР-012942 (
				//Если ТипЗнч(Докк.Док) = Тип("ДокументСсылка.НачислениеПоБольничномуЛисту") Тогда					
					ДокументОбъект = Докк.Док.ПолучитьОбъект();   
					ДокументОбъект.ДокВыгруженНаПортал = Истина;
					ДокументОбъект.Записать();
				//КонецЕсли;
				//КВВ СВФР-012942 )
					
					
				СчДок = СчДок + 1; 
				ТекДата = ТекДата + 1;
				
				//Сообщить(ТекДата);
				ТекГод = Формат(ТекДата, "ДФ=гггг"); 
				ТекМес = Формат(ТекДата, "ДФ=ММ"); 
				ТекДень = Формат(ТекДата, "ДФ=дд"); 
				ТекЧас = Формат(ТекДата, "ДФ=чч"); 
				ТекМин = Формат(ТекДата, "ДФ=мм"); 
				ТекСек = Формат(ТекДата, "ДФ=сс");
				
				ИмяФайлаПачки = "ZU1_" + ОргУНПФСЗН + "_" + ОргУНП + "_" + ?(Флажок2,"2","1") + "_000000_" + ТекГод + ТекМес + ТекДень + ТекЧас + ТекМин + ТекСек;
				
				//	ТекстФайла = "";
				//	ТекстФайла = Новый ТекстовыйДокумент;
				
				
				Данные = Новый Структура;
				Данные.Вставить("ver", "1.0");
				Данные.Вставить("forma", "ZU1");
				Данные.Вставить("unpf", Число(ВставитьВФайл(ОргУНПФСЗН)));
				Данные.Вставить("unp", ВставитьВФайл(ОргУНП));
				Данные.Вставить("plat", ВставитьВФайл(Организация.Наименование));
				Данные.Вставить("type", ?(Флажок2,2,1)); 
				Данные.Вставить("pck", ИмяФайлаПачки);
				Данные.Вставить("tel", СокрЛП(ТелефонОтв));
				Данные.Вставить("ddoc", Формат(ТекДата,"ДФ=dd/MM/yyyy"));
				Данные.Вставить("ndoc", 1);
				
				МассивДанных = Новый Массив;     
				
				ДанныеДок = Новый Структура;
				ДанныеДок.Вставить("num", 1);//СчДок);   
				ДанныеДок.Вставить("ils", ВставитьВФайл(СокрЛП(Докк.ЛичныйНомер)));
				ДанныеДок.Вставить("fzl", ВставитьВФайл(ВРЕГ(СокрЛП(Докк.Фамилия))));
				ДанныеДок.Вставить("izl", ВставитьВФайл(ВРЕГ(СокрЛП(Докк.Имя))));
				ДанныеДок.Вставить("ozl", ВставитьВФайл(ВРЕГ(СокрЛП(Докк.Отчество))));
				ДанныеДок.Вставить("numMed", ВставитьВФайл(СокрЛП(Докк.Серия)+СокРЛП(Докк.Номер)));
				
				Если ЗначениеЗаполнено(Докк.ПервичныйБЛ) 
					И ТипЗнч(Докк.ПервичныйБЛ) <> Тип("ДокументСсылка.ОтсутствиеНаРаботеОрганизаций") Тогда  //КВВ СВФР-012942
					ДанныеДок.Вставить("dfromIns", ?(Флажок2,"",Формат(Докк.ПервичныйБЛ.ДатаНачала,"ДФ=dd/MM/yyyy")));
					ДанныеДок.Вставить("dfromMed", ?(Флажок2,"",Формат(Докк.ПервичныйБЛ.ДатаНачала,"ДФ=dd/MM/yyyy")));
				Иначе
					ДанныеДок.Вставить("dfromIns", ?(Флажок2,"",Формат(Докк.НачалоБЛ,"ДФ=dd/MM/yyyy")));
					ДанныеДок.Вставить("dfromMed", ?(Флажок2,"",Формат(Докк.НачалоБЛ,"ДФ=dd/MM/yyyy")));
				КонецЕсли;
				ДанныеДок.Вставить("dtoMed", ?(Флажок2,"",Формат(Докк.ОкончаниеБЛ,"ДФ=dd/MM/yyyy")));
				
				//Если Флажок2 Тогда  всегда выгружаем prMed   не по постановлению, но портал принимает
				//	ДанныеДок.Вставить("prMed", "");
				//Иначе
					Если Докк.Причина = Перечисления.ПричиныНетрудоспособности.ПоБеременностиИРодам Тогда
						ДанныеДок.Вставить("prMed", 2);
					Иначе
						ДанныеДок.Вставить("prMed", 1);
					КонецЕсли;
				//КонецЕсли;
				ДанныеДок.Вставить("prRel", ?(Докк.ПризнакДогПодряда,3,1));   
				
				//Если Флажок2 Тогда   всегда выгружаем prJoin не по постановлению, но портал принимает
				//	ДанныеДок.Вставить("prJoin", "");
				//Иначе
					
					Если Докк.Сотрудник.ВидЗанятости = Перечисления.ВидыЗанятостиВОрганизации.Совместительство 
						И НЕ (Докк.ПризнакДогПодряда) 
						И Докк.Причина <> Перечисления.ПричиныНетрудоспособности.ПоБеременностиИРодам Тогда   
						ДанныеДок.Вставить("prJoin", 1);
					Иначе
						ДанныеДок.Вставить("prJoin", 0);
					КонецЕсли;
				//КонецЕсли;
				
				Если Докк.ПризнакДогПодряда И ЗначениеЗаполнено(Докк.Док.ДоговорПодряда) Тогда     //КВВ СВФР-012942 (Ссылка на Док)
					ДанныеДок.Вставить("ddog", Формат(Докк.Док.ДоговорПодряда.ДатаПУ,"ДФ=dd/MM/yyyy"));  //КВВ СВФР-012942 (Ссылка на Док) 
					ДанныеДок.Вставить("ndog", СокрЛП(Докк.Док.ДоговорПодряда.НомерДляПу));        //КВВ СВФР-012942 (Ссылка на Док)
				Иначе
					ДанныеДок.Вставить("ddog", "");
					ДанныеДок.Вставить("ndog", "");
				КонецЕсли;
				
				МассивДанных.Добавить(ДанныеДок);
				
				Данные.Вставить("data", МассивДанных);
				
				
				ПутькФайлу = СокрЛП(КаталогВыгрузки); 
				ПутькФайлу = ПутькФайлу + ?(Прав(ПутькФайлу,1)="\","","\"); 
				
				ПутьКФайлуСИменем = ПутьКФайлу + ИмяФайлаПачки + ".txt";
				
				Запись = Новый ЗаписьJSON;
				ПараметрыЗаписиJSON = Новый ПараметрыЗаписиJSON(ПереносСтрокJSON.Авто, " ",Истина);
				Запись.ОткрытьФайл(ПутьКФайлуСИменем,КодировкаТекста.ANSI,, ПараметрыЗаписиJSON);
				
				ЗаписатьJSON(Запись, Данные);
				
				Запись.Закрыть();
				
				
				//	ТекстФайла.Записать( ПутьКФайлу + ИмяФайлаПачки + ".txt", КодировкаТекста.ANSI );
				Сообщить( "Файл сохранен: " + ПутьКФайлу + ИмяФайлаПачки ); 
				
			КонецЦикла;  
			Сообщить("Выгрузка данных завершена!");
		Иначе
			Сообщить("Не найдены документы по заданным условиям, ничего не выгружено.");
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры           

Функция ВставитьВФайл(Значение)
	Если Значение = Null Тогда
		Значение = "";
		Возврат Значение
	Иначе
		Возврат ?(СокрЛП(Значение) = ""," ",СокрЛП(Значение))
	КонецЕсли;
КонецФункции
