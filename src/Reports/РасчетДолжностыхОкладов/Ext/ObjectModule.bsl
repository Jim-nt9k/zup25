Перем мМакет, мНомер;
Перем ТарифСтарыйИтог, ТарифНовыйИтог;
Перем ТарифСтарыйПоПредпрИтог, ТарифновыйПоПредпрИтог;
Перем ТекПодр, ТЗ;

#Если Клиент Тогда

	
Процедура ВывестиСтрокиПодразделения(ВыборкаСтрокШтРасписания, ДокументРезультат)
  
	Пока ВыборкаСтрокШтРасписания.Следующий() Цикл 
		
		ВыборкаПодразделенийСледующегоУровня = ВыборкаСтрокШтРасписания.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкамСИерархией);
		
		Если НЕ ЗначениеЗаполнено(ВыборкаСтрокШтРасписания.Сотрудник) Тогда
			Если (ЗначениеЗаполнено(ТекПодр)) и (ТекПодр <> ВыборкаСтрокШтРасписания.ПодразделениеОрганизации) Тогда
				ОбластьДетальныхЗаписей = мМакет.ПолучитьОбласть("Итого");
				ОбластьДетальныхЗаписей.Параметры.ТарифСтарыйИтог = ТарифСтарыйИтог;
				ОбластьДетальныхЗаписей.Параметры.ТарифНовыйИтог = ТарифНовыйИтог;								
				ДокументРезультат.Вывести(ОбластьДетальныхЗаписей);
				
				ТарифСтарыйИтог = 0;
				ТарифНовыйИтог = 0;
			КонецЕсли;
			
			Если ЗначениеЗаполнено(ВыборкаСтрокШтРасписания.ПодразделениеОрганизации) Тогда
				ОбластьДетальныхЗаписей = мМакет.ПолучитьОбласть("Группа1");
				ПодразделениеОрганизацииКод = СокрЛП(ВыборкаСтрокШтРасписания.ПодразделениеОрганизацииКод);
				ОбластьДетальныхЗаписей.Параметры.ПодразделениеОрганизацииКод = ПодразделениеОрганизацииКод;
				ОбластьДетальныхЗаписей.Параметры.ПодразделениеОрганизацииНаименование = ВыборкаСтрокШтРасписания.ПодразделениеОрганизацииНаименование;				
				ДокументРезультат.Вывести(ОбластьДетальныхЗаписей);
			КонецЕсли;

			мНомер = 0;
		Иначе
			мНомер = мНомер + 1;
			ОбластьДетальныхЗаписей = мМакет.ПолучитьОбласть("Строка");
			ОбластьДетальныхЗаписей.Параметры.Номер = мНомер;
			ОбластьДетальныхЗаписей.Параметры.ТН = ВыборкаСтрокШтРасписания.Сотрудник.Код;	
			ОбластьДетальныхЗаписей.Параметры.Сотрудник = ВыборкаСтрокШтРасписания.СотрудникНаименование;				
			ОбластьДетальныхЗаписей.Параметры.Должность = ВыборкаСтрокШтРасписания.Должность;
			
			НайденнаяСтр = ТЗ.НайтиСтроки(Новый Структура("ПодразделениеОрганизации,Сотрудник,Должность", ВыборкаСтрокШтРасписания.ПодразделениеОрганизации,ВыборкаСтрокШтРасписания.Сотрудник,ВыборкаСтрокШтРасписания.Должность));
			ТС = 0;
			Если НайденнаяСтр.Количество() = 0 Тогда
			Иначе
				ТС = НайденнаяСтр[0].Ставка;
				ОбластьДетальныхЗаписей.Параметры.ТарифСтарый = ТС;									
			КонецЕсли;
			
			ОбластьДетальныхЗаписей.Параметры.КоэффициентЕТС = ВыборкаСтрокШтРасписания.КоэффициентЕТС;
			ОбластьДетальныхЗаписей.Параметры.ПроцентПоКонтракту = ВыборкаСтрокШтРасписания.ПроцентПоКонтракту;
			ОбластьДетальныхЗаписей.Параметры.ИтоговоеПовышениеПоИнструкции = ВыборкаСтрокШтРасписания.ИтоговоеПовышениеПоИнструкции;
			ОбластьДетальныхЗаписей.Параметры.ТехнологическийКоэф = ВыборкаСтрокШтРасписания.ПовышенныйКоэффициентЕТС;
			
			ПараметрыСтавки = РегистрыСведений.ТарифныеСтавкиПервогоРазрядаОрганизаций.ПолучитьПоследнее(ДатаАктуальности,
			Новый Структура("Организация, ТарифнаяСтавка", ВыборкаСтрокШтРасписания.ПодразделениеОрганизации.Владелец, ВыборкаСтрокШтРасписания.РазмерСтавки1Разряда));
			СтавкаПервого = ПараметрыСтавки.Размер;
			
			ОбластьДетальныхЗаписей.Параметры.СтавкаПервогоРазряда = СтавкаПервого;
			
			мТарифнаяСтавкаРазряд = ВыборкаСтрокШтРасписания.КоэффициентЕТС * СтавкаПервого;
			ОбластьДетальныхЗаписей.Параметры.ТарифНовый = ВыборкаСтрокШтРасписания.Ставка;
			
			ДокументРезультат.Вывести(ОбластьДетальныхЗаписей);
			
			//подсчитываем итоги
			ТарифСтарыйИтог = ТарифСтарыйИтог + ТС;
			ТарифНовыйИтог = ТарифНовыйИтог + ВыборкаСтрокШтРасписания.Ставка;
			ТарифСтарыйПоПредпрИтог = ТарифСтарыйПоПредпрИтог + ТС;
			ТарифНовыйПоПредпрИтог = ТарифНовыйПоПредпрИтог + ВыборкаСтрокШтРасписания.Ставка;

			ТекПодр = ВыборкаСтрокШтРасписания.ПодразделениеОрганизации;
		КонецЕсли;
		ВывестиСтрокиПодразделения(ВыборкаПодразделенийСледующегоУровня, ДокументРезультат)
		
	КонецЦикла;//цикл по подразделениям текущего уровня 	
КонецПроцедуры
	
////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ ОБЩЕГО НАЗНАЧЕНИЯ
// Выполняет запрос и формирует табличный документ-результат отчета
// в соответствии с настройками, заданными значениями реквизитов отчета.
//
// Параметры:
//	ДокументРезультат - табличный документ, формируемый отчетом
//  Дописать - булево.  Истина - табличный документ дописывается формируемым отчетом, 
//                      Ложь - заполняется формируемым отчетом (с предварительной очистой 
//                      табличного документа)
//
Процедура СформироватьОтчет(ДокументРезультат, Дописать = Ложь) Экспорт
   ТарифСтарыйИтог = 0; ТарифНовыйИтог = 0; ТекПодр = ""; 
   ТарифСтарыйПоПредпрИтог = 0; ТарифНовыйПоПредпрИтог = 0;	
   
	ЗапросПред = Новый Запрос;
	ТекстЗапросаПред =
	"ВЫБРАТЬ
	|	РаботникиОрганизации.Сотрудник КАК Сотрудник,
	|	ВЫБОР
	|		КОГДА РаботникиОрганизации.ПериодЗавершения <= &Период
	|				И РаботникиОрганизации.ПериодЗавершения <> ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)
	|			ТОГДА РаботникиОрганизации.ЗанимаемыхСтавокЗавершения
	|		ИНАЧЕ РаботникиОрганизации.ЗанимаемыхСтавок
	|	КОНЕЦ КАК ЗанимаемыхСтавок,
	|	РаботникиОрганизации.ПодразделениеОрганизации КАК ПодразделениеОрганизации,
	|	РаботникиОрганизации.Должность КАК Должность,
	|	ТарифныеСтавкиРаботниковОрганизации.Ставка КАК Ставка,
	|	РаботникиОрганизации.Должность.Код,
	|	РаботникиОрганизации.ПодразделениеОрганизации.Код КАК ПодразделениеОрганизацииКод,					
	|	РаботникиОрганизации.ПодразделениеОрганизации.Наименование КАК ПодразделениеОрганизацииНаименование,
	|	РаботникиОрганизации.Сотрудник КАК СотрудникНаименование
	|ИЗ
	|	РегистрСведений.РаботникиОрганизаций.СрезПоследних(&Период, (НЕ Временно)) КАК РаботникиОрганизации
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ТарифныеСтавкиРаботниковОрганизации.СрезПоследних(&Период, ) КАК ТарифныеСтавкиРаботниковОрганизации
	|			ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|				ПлановыеНачисленияРаботниковОрганизацийСрезПоследних.Сотрудник КАК Сотрудник,
	|				ПлановыеНачисленияРаботниковОрганизацийСрезПоследних.Регистратор КАК Ссылка
	|			ИЗ
	|				РегистрСведений.ПлановыеНачисленияРаботниковОрганизаций.СрезПоследних(&Период, (НЕ временно)) КАК ПлановыеНачисленияРаботниковОрганизацийСрезПоследних
	|			ГДЕ
	|				ПлановыеНачисленияРаботниковОрганизацийСрезПоследних.Организация = &Организация
	|				И ПлановыеНачисленияРаботниковОрганизацийСрезПоследних.ВидРасчетаИзмерение = НЕОПРЕДЕЛЕНО) КАК ВидТС
	|			ПО ТарифныеСтавкиРаботниковОрганизации.Сотрудник = ВидТС.Сотрудник
	|		ПО РаботникиОрганизации.Сотрудник = ТарифныеСтавкиРаботниковОрганизации.Сотрудник
	|ГДЕ
	|	(НЕ РаботникиОрганизации.Сотрудник ЕСТЬ NULL )
	|	И РаботникиОрганизации.ПодразделениеОрганизации.Владелец = &Организация
	|	И ВЫБОР
	|			КОГДА РаботникиОрганизации.ПериодЗавершения <= &Период
	|					И РаботникиОрганизации.ПериодЗавершения <> ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)
	|				ТОГДА РаботникиОрганизации.ЗанимаемыхСтавокЗавершения
	|			ИНАЧЕ РаботникиОрганизации.ЗанимаемыхСтавок
	|		КОНЕЦ <> 0
	|	И (НЕ РаботникиОрганизации.Сотрудник В
	|				(ВЫБРАТЬ
	|					СостояниеРаботниковОрганизаций.Сотрудник
	|				ИЗ
	|					РегистрСведений.СостояниеРаботниковОрганизаций КАК СостояниеРаботниковОрганизаций
	|				ГДЕ
	|					СостояниеРаботниковОрганизаций.Состояние = ЗНАЧЕНИЕ(Перечисление.СостоянияРаботникаОрганизации.ОтпускПоУходуЗаРебенком)
	|					И СостояниеРаботниковОрганизаций.ПериодЗавершения >= &Период))
	|	И РаботникиОрганизации.Сотрудник.ВидЗанятости <> ЗНАЧЕНИЕ(Перечисление.ВидыЗанятостиВОрганизации.Совместительство)
	|
	|СГРУППИРОВАТЬ ПО
	|	РаботникиОрганизации.ПодразделениеОрганизации,
	|	РаботникиОрганизации.Должность,
	//|	РаботникиОрганизации.Сотрудник,
	|	ТарифныеСтавкиРаботниковОрганизации.Ставка,
	|	РаботникиОрганизации.ПодразделениеОрганизации.Код,			
	|	РаботникиОрганизации.ПодразделениеОрганизации.Наименование,
	|	ВЫБОР
	|		КОГДА РаботникиОрганизации.ПериодЗавершения <= &Период
	|				И РаботникиОрганизации.ПериодЗавершения <> ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)
	|			ТОГДА РаботникиОрганизации.ЗанимаемыхСтавокЗавершения
	|		ИНАЧЕ РаботникиОрганизации.ЗанимаемыхСтавок
	|	КОНЕЦ,
	|	РаботникиОрганизации.Сотрудник
	|
	|УПОРЯДОЧИТЬ ПО
	|	ПодразделениеОрганизацииКод,
	|	ПодразделениеОрганизацииНаименование,
	|	Должность,
	|	Сотрудник";

	ЗапросПред.УстановитьПараметр("Период",	ДатаАктуальности - 60*60*24);
	ЗапросПред.УстановитьПараметр("Организация",		Организация);   
	ЗапросПред.УстановитьПараметр("Подразделение",      Подразделение);
	
	Если Не Подразделение.Пустая() Тогда
		Если Не Подразделение.Родитель.Пустая() Тогда
			ТекстЗапросаПред = СтрЗаменить(ТекстЗапросапред,"ПодразделениеОрганизации.Владелец = &Организация","ПодразделениеОрганизации В (&Подразделение)")
		Иначе
			ТекстЗапросаПред = СтрЗаменить(ТекстЗапросапред,"ПодразделениеОрганизации.Владелец = &Организация","ПодразделениеОрганизации.Родитель В (&Подразделение)")		
		КонецЕсли;
	КонецЕсли;
	ЗапросПред.Текст = ТекстЗапросаПред;
	
	РезультатЗапроса = ЗапросПред.Выполнить();

	ТЗ = Новый ТаблицаЗначений;
	ТЗ = РезультатЗапроса.Выгрузить();
	                                      
	Запрос = Новый Запрос;
	ТекстЗапроса =
	"ВЫБРАТЬ
	|	РаботникиОрганизации.Сотрудник КАК Сотрудник,
	|	ВЫБОР
	|		КОГДА РаботникиОрганизации.ПериодЗавершения <= &Период
	|				И РаботникиОрганизации.ПериодЗавершения <> ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)
	|			ТОГДА РаботникиОрганизации.ЗанимаемыхСтавокЗавершения
	|		ИНАЧЕ РаботникиОрганизации.ЗанимаемыхСтавок
	|	КОНЕЦ КАК ЗанимаемыхСтавок,
	|	РаботникиОрганизации.ПодразделениеОрганизации КАК ПодразделениеОрганизации,
	|	РаботникиОрганизации.Должность КАК Должность,
	|	РаботникиОрганизации.РазрядЕТС,
	|	РаботникиОрганизации.КоэффициентЕТС,
	|	РаботникиОрганизации.Категория,
	|	ТарифныеСтавкиРаботниковОрганизации.Ставка КАК Ставка,
	|	ТарифныеСтавкиРаботниковОрганизации.ПроцентПоКонтракту,
	|	ТарифныеСтавкиРаботниковОрганизации.ТарифнаяСтавка КАК ТарифнаяСтавка,
	|	ТарифныеСтавкиРаботниковОрганизации.ТарифнаяСПовышениемПоИнструкции КАК ТарифнаяСПовышениемПоИнструкции,
	|	РаботникиОрганизации.Должность.Код,
	|	РаботникиОрганизации.ПодразделениеОрганизации.Код КАК ПодразделениеОрганизацииКод,					
	|	РаботникиОрганизации.ПодразделениеОрганизации.Наименование КАК ПодразделениеОрганизацииНаименование,
	|	РаботникиОрганизации.ИтоговоеПовышениеПоИнструкции,
	|	РаботникиОрганизации.ПовышенныйКоэффициентЕТС,
	|	РаботникиОрганизации.ТарифнаяСтавкаПервогоРазряда КАК РазмерСтавки1Разряда,	
	|	РаботникиОрганизации.Сотрудник КАК СотрудникНаименование
	|ИЗ
	|	РегистрСведений.РаботникиОрганизаций.СрезПоследних(&Период, (НЕ Временно)) КАК РаботникиОрганизации
	|		ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.ТарифныеСтавкиРаботниковОрганизации.СрезПоследних(&Период, ) КАК ТарифныеСтавкиРаботниковОрганизации
	|			ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|				ПлановыеНачисленияРаботниковОрганизацийСрезПоследних.ВидРасчета КАК ВидРасчета,
	|				ПлановыеНачисленияРаботниковОрганизацийСрезПоследних.Сотрудник КАК Сотрудник,
	|				ПлановыеНачисленияРаботниковОрганизацийСрезПоследних.Регистратор КАК Ссылка
	|			ИЗ
	|				РегистрСведений.ПлановыеНачисленияРаботниковОрганизаций.СрезПоследних(&Период, (НЕ временно)) КАК ПлановыеНачисленияРаботниковОрганизацийСрезПоследних
	|			ГДЕ
	|				ПлановыеНачисленияРаботниковОрганизацийСрезПоследних.Организация = &Организация
	|				И ПлановыеНачисленияРаботниковОрганизацийСрезПоследних.ВидРасчетаИзмерение = НЕОПРЕДЕЛЕНО) КАК ВидТС
	|			ПО ТарифныеСтавкиРаботниковОрганизации.Сотрудник = ВидТС.Сотрудник
	|		ПО РаботникиОрганизации.Сотрудник = ТарифныеСтавкиРаботниковОрганизации.Сотрудник
	|ГДЕ
	|	(НЕ РаботникиОрганизации.Сотрудник ЕСТЬ NULL )
	|	И РаботникиОрганизации.ПодразделениеОрганизации.Владелец = &Организация
	|	И ВЫБОР
	|			КОГДА РаботникиОрганизации.ПериодЗавершения <= &Период
	|					И РаботникиОрганизации.ПериодЗавершения <> ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)
	|				ТОГДА РаботникиОрганизации.ЗанимаемыхСтавокЗавершения
	|			ИНАЧЕ РаботникиОрганизации.ЗанимаемыхСтавок
	|		КОНЕЦ <> 0
	|	И (НЕ РаботникиОрганизации.Сотрудник В
	|				(ВЫБРАТЬ
	|					СостояниеРаботниковОрганизаций.Сотрудник
	|				ИЗ
	|					РегистрСведений.СостояниеРаботниковОрганизаций КАК СостояниеРаботниковОрганизаций
	|				ГДЕ
	|					СостояниеРаботниковОрганизаций.Состояние = ЗНАЧЕНИЕ(Перечисление.СостоянияРаботникаОрганизации.ОтпускПоУходуЗаРебенком)
	|					И СостояниеРаботниковОрганизаций.ПериодЗавершения >= &Период))
	|	И РаботникиОрганизации.Сотрудник.ВидЗанятости <> ЗНАЧЕНИЕ(Перечисление.ВидыЗанятостиВОрганизации.Совместительство)
	|
	|СГРУППИРОВАТЬ ПО
	|	РаботникиОрганизации.ПодразделениеОрганизации,
	|	РаботникиОрганизации.Должность,
	|	РаботникиОрганизации.Сотрудник,
	|	РаботникиОрганизации.РазрядЕТС,
	|	РаботникиОрганизации.КоэффициентЕТС,
	|	РаботникиОрганизации.Категория,
	|	ТарифныеСтавкиРаботниковОрганизации.Ставка,
	|	ТарифныеСтавкиРаботниковОрганизации.ПроцентПоКонтракту,
	|	ТарифныеСтавкиРаботниковОрганизации.ТарифнаяСтавка,
	|	ТарифныеСтавкиРаботниковОрганизации.ТарифнаяСПовышениемПоИнструкции,
	|	РаботникиОрганизации.Должность.Код,
	|	РаботникиОрганизации.ПодразделениеОрганизации.Код,			
	|	РаботникиОрганизации.ПодразделениеОрганизации.Наименование,
	|	РаботникиОрганизации.ТарифнаяСтавкаПервогоРазряда,		
	|	РаботникиОрганизации.ИтоговоеПовышениеПоИнструкции,
	|	ВЫБОР
	|		КОГДА РаботникиОрганизации.ПериодЗавершения <= &Период
	|				И РаботникиОрганизации.ПериодЗавершения <> ДАТАВРЕМЯ(1, 1, 1, 0, 0, 0)
	|			ТОГДА РаботникиОрганизации.ЗанимаемыхСтавокЗавершения
	|		ИНАЧЕ РаботникиОрганизации.ЗанимаемыхСтавок
	|	КОНЕЦ,
	|	РаботникиОрганизации.ПовышенныйКоэффициентЕТС,
	|	РаботникиОрганизации.Сотрудник
	|
	|УПОРЯДОЧИТЬ ПО
	|	ПодразделениеОрганизацииКод,
	|	ПодразделениеОрганизацииНаименование,
	|	Должность,
	|	Сотрудник
	|ИТОГИ
	//|	СУММА(ЗанимаемыхСтавок),
	|	СУММА(Ставка),
	|	СУММА(ТарифнаяСтавка),
	|	СУММА(ТарифнаяСПовышениемПоИнструкции)
	|ПО
	|	ОБЩИЕ,
	|	ПодразделениеОрганизации ИЕРАРХИЯ";

	Запрос.УстановитьПараметр("Период",	ДатаАктуальности);
	Запрос.УстановитьПараметр("Организация",		Организация);   
	Запрос.УстановитьПараметр("Подразделение",      Подразделение);
	
	Если Не Подразделение.Пустая() Тогда
    	ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"ПодразделениеОрганизации.Владелец = &Организация","ПодразделениеОрганизации В ИЕРАРХИИ(&Подразделение)")
	КонецЕсли;
	Запрос.Текст = ТекстЗапроса;
	
	РезультатЗапроса = Запрос.Выполнить();
	
	ДокументРезультат.Очистить();

	Область = мМакет.ПолучитьОбласть("Заголовок");
	Область.Параметры.Организация = Организация;	
	Область.Параметры.Период = ПредставлениеПериода(НачалоМесяца(ДатаАктуальности), КонецМесяца(ДатаАктуальности), "ДФ=""ММММ.гггг""");
	ДокументРезультат.Вывести(Область);
					
	//Параметры документа
	ДокументРезультат.ОриентацияСтраницы = ОриентацияСтраницы.Портрет;
	ДокументРезультат.ПолеСлева			 = 0;
	ДокументРезультат.ПолеСправа		 = 0;
		
	Область = мМакет.ПолучитьОбласть("Шапка");
	ДокументРезультат.Вывести(Область);
	
	ВыборкаИтог = РезультатЗапроса.Выбрать(ОбходРезультатаЗапроса.Прямой);
	
	мНомер = 0;
	ВывестиСтрокиПодразделения(ВыборкаИтог, ДокументРезультат);
	
	Область = мМакет.ПолучитьОбласть("Итого");
	Область.Параметры.ТарифСтарыйИтог = ТарифСтарыйИтог;
	Область.Параметры.ТарифНовыйИтог = ТарифНовыйИтог;								
	ДокументРезультат.Вывести(Область);
	
	Область = мМакет.ПолучитьОбласть("ИтогоПоПредприятию");
	Область.Параметры.ТарифСтарыйПоПредпрИтог = ТарифСтарыйПоПредпрИтог;
	Область.Параметры.ТарифНовыйПоПредпрИтог = ТарифНовыйПоПредпрИтог;								
	ДокументРезультат.Вывести(Область);
	
КонецПроцедуры

мМакет = ПолучитьМакет("МакетРасчетДолжностныхОкладов");

#КонецЕсли

