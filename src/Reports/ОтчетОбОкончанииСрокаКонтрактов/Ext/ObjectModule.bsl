Перем мМакет, мНомер;
Перем ТекПодр;

#Если Клиент Тогда
	
Функция СформируемЗапросПоЗаключенномуКонтракту(ВыбСотрудник)
	//Аверсон 07.01.2023 КВВ СВФР-010125 (
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ДействиеТрудовогоДоговора",Перечисления.ТипТрудовогоДоговора.Заключен);
	Запрос.УстановитьПараметр("Сотрудник",ВыбСотрудник);
	Запрос.УстановитьПараметр("ВидДоговора",Перечисления.ВидыДоговоровСФизЛицами.Контракт);
	
	Запрос.Текст = 
	"ВЫБРАТЬ
	|	РаботникиОрганизацийСрезПоследних.Организация,
	|	РаботникиОрганизацийСрезПоследних.ПодразделениеОрганизации КАК ПодразделениеОрганизации,
	|	РаботникиОрганизацийСрезПоследних.Должность,
	|	ТрудовыеДоговораСрезПоследних.НачалоДоговора,
	|	ТрудовыеДоговораСрезПоследних.Регистратор
	|ИЗ
	|	РегистрСведений.РаботникиОрганизаций КАК РаботникиОрганизацийСрезПоследних
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ТрудовыеДоговора КАК ТрудовыеДоговораСрезПоследних
	|		ПО РаботникиОрганизацийСрезПоследних.Сотрудник = ТрудовыеДоговораСрезПоследних.Сотрудник
	|ГДЕ
	|   ТрудовыеДоговораСрезПоследних.Сотрудник = &Сотрудник 
	|	И ТрудовыеДоговораСрезПоследних.ДействиеТрудовогоДоговора = &ДействиеТрудовогоДоговора
	|	И ТрудовыеДоговораСрезПоследних.ВидДоговора = &ВидДоговора";
	
	РезультатЗапроса = Запрос.Выполнить();
	Возврат РезультатЗапроса;
	//Аверсон 07.01.2023 КВВ СВФР-010125 )
КонецФункции

Процедура ВывестиСтрокиПодразделения(ВыборкаСтрокКонтракта, ДокументРезультат)
	
	//Аверсон ЕАЕ 26.08.2025 СВФР-016443
	//Климовичи
	Если Организация.ИНН = "700103211" Тогда
		мСквознаяНумерацияНомер = 0;
	КонецЕсли;
	//Аверсон СВФР-016443
	
	Пока ВыборкаСтрокКонтракта.Следующий() Цикл 
		
		ВыборкаПодразделенийСледующегоУровня = ВыборкаСтрокКонтракта.Выбрать(ОбходРезультатаЗапроса.ПоГруппировкамСИерархией);
		
		//Аверсон 04.03.2020 КВВ СВФР-005600 (
		Если ВыводитьПоОсновнымДоговорам Тогда
			Если ВыборкаСтрокКонтракта.Регистратор <> ВыборкаСтрокКонтракта.Сотрудник.ТрудовойДоговор Тогда
				Продолжить;
			КонецЕсли;
		КонецЕсли;
		//Аверсон 04.03.2020 КВВ СВФР-005600 )
		
		//Аверсон ЕАЕ 26.08.2025 СВФР-016443
		//Климовичи
		Если Организация.ИНН = "700103211" Тогда
			мСквознаяНумерацияНомер = мСквознаяНумерацияНомер + 1;
		КонецЕсли;
		//Аверсон СВФР-016443
		
		//Аверсон 07.01.2023 КВВ СВФР-010125 (
		ПолныхЛет = 0; Год = 0;  НачалоЗаключенногоКонтракта = Дата(1,1,1);
		ЗаключенныйКонтракт = СформируемЗапросПоЗаключенномуКонтракту(ВыборкаСтрокКонтракта.Сотрудник).Выбрать();
		Пока ЗаключенныйКонтракт.Следующий() Цикл
			НачалоЗаключенногоКонтракта = ЗаключенныйКонтракт.НачалоДоговора;
		КонецЦикла; 
		Если НачалоЗаключенногоКонтракта <> Дата(1,1,1) Тогда
			Лет = 0;   Месяцев = 0;  Дней = 0; 
			ОбщегоНазначения.РазобратьРазностьДат(ВыборкаСтрокКонтракта.ОкончаниеДоговора + 86400,НачалоЗаключенногоКонтракта, Лет, Месяцев, Дней);
			Если Лет < 5 Тогда
				ПолныхЛет = 5 - Лет;
			Иначе
				ПолныхЛет = 5;
			КонецЕсли;
		КонецЕсли;
		//Аверсон 07.01.2023 КВВ СВФР-010125 )
		
		Если ПустаяСтрока(ТекПодр) или ТекПодр <> ВыборкаСтрокКонтракта.ПодразделениеОрганизации Тогда			
			мНомер = 0;
			
			//Аверсон ЕАЕ 26.08.2025 СВФР-016443
			//Климовичи
			Если Организация.ИНН <> "700103211" Тогда
			//Аверсон СВФР-016443
				ОбластьДетальныхЗаписей = мМакет.ПолучитьОбласть("Группа1");
				ПодразделениеОрганизацииКод = СокрЛП(ВыборкаСтрокКонтракта.ПодразделениеОрганизацииКод);
				ОбластьДетальныхЗаписей.Параметры.ПодразделениеОрганизацииКод = ПодразделениеОрганизацииКод;
				ОбластьДетальныхЗаписей.Параметры.ПодразделениеОрганизацииНаименование = ВыборкаСтрокКонтракта.ПодразделениеОрганизацииНаименование;				
				ДокументРезультат.Вывести(ОбластьДетальныхЗаписей);
			КонецЕсли;
		
			мНомер = мНомер + 1;
			ОбластьДетальныхЗаписей = мМакет.ПолучитьОбласть("Строка");
			ОбластьДетальныхЗаписей.Параметры.Номер = мНомер;
			
			//Аверсон ЕАЕ 26.08.2025 СВФР-016443
			//Климовичи
			Если Организация.ИНН = "700103211" Тогда
				ОбластьДетальныхЗаписей.Параметры.Номер = мСквознаяНумерацияНомер;	
			Иначе
				ОбластьДетальныхЗаписей.Параметры.ТН = ВыборкаСтрокКонтракта.Сотрудник.Код;
			КонецЕсли;
			//ОбластьДетальныхЗаписей.Параметры.ТН = ВыборкаСтрокКонтракта.Сотрудник.Код;	
			//Аверсон СВФР-016443
			
			ОбластьДетальныхЗаписей.Параметры.Сотрудник = ВыборкаСтрокКонтракта.Сотрудник.Наименование;				
			ОбластьДетальныхЗаписей.Параметры.Должность = ВыборкаСтрокКонтракта.Должность;
			ОбластьДетальныхЗаписей.Параметры.ДатаКонтракта = ВыборкаСтрокКонтракта.Регистратор.ДатаТД;  //Аверсон 28.08.2019 КВВ СВФР-004690
			ОбластьДетальныхЗаписей.Параметры.НомерКонтракта = ВыборкаСтрокКонтракта.НомерТД;
			ОбластьДетальныхЗаписей.Параметры.НачалоКонтракта = ВыборкаСтрокКонтракта.НачалоДоговора;
			ОбластьДетальныхЗаписей.Параметры.ОкончаниеКонтракта = ВыборкаСтрокКонтракта.ОкончаниеДоговора;
			
			//Аверсон 07.01.2023 КВВ СВФР-010125 (
			Лет = 0;  Месяцев = 0;   Дней = 0; 
			ОбщегоНазначения.РазобратьРазностьДат(РабочаяДата,ВыборкаСтрокКонтракта.Сотрудник.Физлицо.ДатаРождения, Лет, Месяцев, Дней);
			ОбластьДетальныхЗаписей.Параметры.Возраст = Лет;			
			ОбластьДетальныхЗаписей.Параметры.ПродлениеКонтракта = ПолныхЛет;
			//Аверсон 07.01.2023 КВВ СВФР-010125 )
			
			//Аверсон ЕАЕ 26.08.2025 СВФР-016443
			//Климовичи
			Если Организация.ИНН = "700103211" Тогда
				ОбластьДетальныхЗаписей.Параметры.ПодразделениеОрганизации = ВыборкаСтрокКонтракта.ПодразделениеОрганизацииНаименование;	
			КонецЕсли;
			//Аверсон СВФР-016443
			
			ДокументРезультат.Вывести(ОбластьДетальныхЗаписей);
			
			ТекПодр = ВыборкаСтрокКонтракта.ПодразделениеОрганизации;
		Иначе
			мНомер = мНомер + 1;
			ОбластьДетальныхЗаписей = мМакет.ПолучитьОбласть("Строка");
			ОбластьДетальныхЗаписей.Параметры.Номер = мНомер;
			
			//Аверсон ЕАЕ 26.08.2025 СВФР-016443
			//Климовичи
			Если Организация.ИНН = "700103211" Тогда
				ОбластьДетальныхЗаписей.Параметры.Номер = мСквознаяНумерацияНомер;
			Иначе
				ОбластьДетальныхЗаписей.Параметры.ТН = ВыборкаСтрокКонтракта.Сотрудник.Код;
			КонецЕсли;
			//ОбластьДетальныхЗаписей.Параметры.ТН = ВыборкаСтрокКонтракта.Сотрудник.Код;	
			//Аверсон СВФР-016443
			
			ОбластьДетальныхЗаписей.Параметры.Сотрудник = ВыборкаСтрокКонтракта.Сотрудник.Наименование;				
			ОбластьДетальныхЗаписей.Параметры.Должность = ВыборкаСтрокКонтракта.Должность;
			ОбластьДетальныхЗаписей.Параметры.ДатаКонтракта = ВыборкаСтрокКонтракта.Регистратор.ДатаТД;  //Аверсон 28.08.2019 КВВ СВФР-004690
			ОбластьДетальныхЗаписей.Параметры.НомерКонтракта = ВыборкаСтрокКонтракта.НомерТД;
			ОбластьДетальныхЗаписей.Параметры.НачалоКонтракта = ВыборкаСтрокКонтракта.НачалоДоговора;
			ОбластьДетальныхЗаписей.Параметры.ОкончаниеКонтракта = ВыборкаСтрокКонтракта.ОкончаниеДоговора;
						
			//Аверсон 07.01.2023 КВВ СВФР-010125 (
			Лет = 0;  Месяцев = 0;   Дней = 0; 
			ОбщегоНазначения.РазобратьРазностьДат(РабочаяДата,ВыборкаСтрокКонтракта.Сотрудник.Физлицо.ДатаРождения, Лет, Месяцев, Дней);
			ОбластьДетальныхЗаписей.Параметры.Возраст = Лет;			
			ОбластьДетальныхЗаписей.Параметры.ПродлениеКонтракта = ПолныхЛет;
			//Аверсон 07.01.2023 КВВ СВФР-010125 )
			
			//Аверсон ЕАЕ 26.08.2025 СВФР-016443
			//Климовичи
			Если Организация.ИНН = "700103211" Тогда
				ОбластьДетальныхЗаписей.Параметры.ПодразделениеОрганизации = ВыборкаСтрокКонтракта.ПодразделениеОрганизацииНаименование;	
			КонецЕсли;
			//Аверсон СВФР-016443
			
			ДокументРезультат.Вывести(ОбластьДетальныхЗаписей);
			
			ТекПодр = ВыборкаСтрокКонтракта.ПодразделениеОрганизации;
		КонецЕсли;
		ВывестиСтрокиПодразделения(ВыборкаПодразделенийСледующегоУровня, ДокументРезультат)
		
	КонецЦикла;//цикл по подразделениям текущего уровня 	
КонецПроцедуры

////////////////////////////////////////////////////////////////////////////////
// ПРОЦЕДУРЫ И ФУНКЦИИ ОБЩЕГО НАЗНАЧЕНИЯ
// Выполняет запрос и формирует табличный документ-результат отчета
// в соответствии с настройками, заданными значениями реквизитов отчета.
//
// Параметры:
//	ДокументРезультат - табличный документ, формируемый отчетом
//  Дописать - булево.  Истина - табличный документ дописывается формируемым отчетом, 
//                      Ложь - заполняется формируемым отчетом (с предварительной очистой 
//                      табличного документа)
//
Процедура СформироватьОтчет(ДокументРезультат, Дописать = Ложь) Экспорт
	ТекПодр = ""; 
	
	//Аверсон ЕАЕ 26.08.2025 СВФР-016443
	//Климовичи
	Если Организация.ИНН = "700103211" Тогда
		мМакет = ПолучитьМакет("МакетОтчетаБезГруппировкиПоПодразделениям");
	Иначе
		мМакет = ПолучитьМакет("МакетОтчета");
	КонецЕсли;
	//Аверсон СВФР-016443
	
	СписокТиповТрудовогоДоговора = Новый СписокЗначений;	
	Если ПустаяСтрока(Тип) Тогда	
		СписокТиповТрудовогоДоговора.Добавить(Перечисления.ТипТрудовогоДоговора.Заключен);
		СписокТиповТрудовогоДоговора.Добавить(Перечисления.ТипТрудовогоДоговора.Продлен);
	Иначе
		СписокТиповТрудовогоДоговора = Новый СписокЗначений;
		СписокТиповТрудовогоДоговора.Добавить(Тип);
	КонецЕсли;
	
	Запрос = Новый Запрос;
	ТекстЗапроса =
	"ВЫБРАТЬ
	|	РаботникиОрганизацийСрезПоследних.Организация," + 
	
	//Аверсон ЕАЕ 22.12.2021 СВФР-008520
	//Для Бобруйска: если заполнено ПодразделениеДляПечати в Подразделении - выводим Подразделение для печати,
	//если нет - Подразделение.
	
	//|	РаботникиОрганизацийСрезПоследних.ПодразделениеОрганизации КАК ПодразделениеОрганизации,
	//|	РаботникиОрганизацийСрезПоследних.ПодразделениеОрганизации.Наименование КАК ПодразделениеОрганизацииНаименование,
	//|	РаботникиОрганизацийСрезПоследних.ПодразделениеОрганизации.Код КАК ПодразделениеОрганизацииКод," 
	
	?(Организация.ИНН = "700067572","
	
	|	ВЫБОР 
	|	КОГДА РаботникиОрганизацийСрезПоследних.ПодразделениеОрганизации.ПодразделениеДляПечати = ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка)
	|	ТОГДА РаботникиОрганизацийСрезПоследних.ПодразделениеОрганизации
	|	ИНАЧЕ РаботникиОрганизацийСрезПоследних.ПодразделениеОрганизации.ПодразделениеДляПечати
	|	КОНЕЦ КАК ПодразделениеОрганизации, 
	|	ВЫБОР 
	|	КОГДА РаботникиОрганизацийСрезПоследних.ПодразделениеОрганизации.ПодразделениеДляПечати = ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка)
	|	ТОГДА РаботникиОрганизацийСрезПоследних.ПодразделениеОрганизации.Наименование
	|	ИНАЧЕ РаботникиОрганизацийСрезПоследних.ПодразделениеОрганизации.ПодразделениеДляПечати.Наименование
	|	КОНЕЦ КАК ПодразделениеОрганизацииНаименование,
	|	ВЫБОР 
	|	КОГДА РаботникиОрганизацийСрезПоследних.ПодразделениеОрганизации.ПодразделениеДляПечати = ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка)
	|	ТОГДА РаботникиОрганизацийСрезПоследних.ПодразделениеОрганизации.Код
	|	ИНАЧЕ РаботникиОрганизацийСрезПоследних.ПодразделениеОрганизации.ПодразделениеДляПечати.Код
	|	КОНЕЦ КАК ПодразделениеОрганизацииКод,","
	
	|	РаботникиОрганизацийСрезПоследних.ПодразделениеОрганизации КАК ПодразделениеОрганизации,
	|	РаботникиОрганизацийСрезПоследних.ПодразделениеОрганизации.Наименование КАК ПодразделениеОрганизацииНаименование,
	|	РаботникиОрганизацийСрезПоследних.ПодразделениеОрганизации.Код КАК ПодразделениеОрганизацииКод,") + "
	//Аверсон СВФР-008520
	
	|	РаботникиОрганизацийСрезПоследних.Должность,
	|	ТрудовыеДоговора.Период,
	|	ТрудовыеДоговора.Регистратор,
	|	ТрудовыеДоговора.Сотрудник КАК Сотрудник,
	|	ТрудовыеДоговора.ВидДоговора,
	|	ТрудовыеДоговора.НомерТД,
	|	ТрудовыеДоговора.ДействиеТрудовогоДоговора,
	|	ТрудовыеДоговора.НачалоДоговора,
	|	ТрудовыеДоговора.ОкончаниеДоговора,
	|	ТрудовыеДоговора.ПроцентПоКонтракту
	|ИЗ
	|	РегистрСведений.РаботникиОрганизаций.СрезПоследних(&Период,) КАК РаботникиОрганизацийСрезПоследних
	|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ РегистрСведений.ТрудовыеДоговора КАК ТрудовыеДоговора
	|		ПО РаботникиОрганизацийСрезПоследних.Сотрудник = ТрудовыеДоговора.Сотрудник
	|ГДЕ
	|	ТрудовыеДоговора.ОкончаниеДоговора >= &НачалоПериода
	|	И ТрудовыеДоговора.ОкончаниеДоговора <= &ОкончаниеПериода
	|	И ТрудовыеДоговора.ДействиеТрудовогоДоговора В (&ДействиеТрудовогоДоговора)
	|   //И ТрудовыеДоговора.ВидДоговора = &ВидДоговора
	|   И РаботникиОрганизацийСрезПоследних.ЗанимаемыхСтавок <> 0	
	|   И РаботникиОрганизацийСрезПоследних.Организация = &Организация";
	Если ЗначениеЗаполнено(Подразделение) Тогда //О.Т. Аверсон 06.11.2018 № 2753
		
		//Аверсон ЕАЕ 22.12.2021 СВФР-008520
		Если Организация.ИНН = "700067572" Тогда
			ТекстЗапроса = ТекстЗапроса +"
			|   И (ВЫБОР 
			|		КОГДА РаботникиОрганизацийСрезПоследних.ПодразделениеОрганизации.ПодразделениеДляПечати = ЗНАЧЕНИЕ(Справочник.ПодразделенияОрганизаций.ПустаяСсылка)
			|		ТОГДА РаботникиОрганизацийСрезПоследних.ПодразделениеОрганизации
			|		ИНАЧЕ РаботникиОрганизацийСрезПоследних.ПодразделениеОрганизации.ПодразделениеДляПечати
			|	   КОНЕЦ) В ИЕРАРХИИ (&Подразделение)";
		Иначе
			//Аверсон СВФР-008520
			
			ТекстЗапроса = ТекстЗапроса +"
			|   И РаботникиОрганизацийСрезПоследних.ПодразделениеОрганизации В ИЕРАРХИИ (&Подразделение)";
		КонецЕсли;
	КонецЕсли;
	
	ТекстЗапроса = ТекстЗапроса +"	
	|УПОРЯДОЧИТЬ ПО 
	
	//Аверсон ЕАЕ 31.01.2025 СВФР-014700
	|   ТрудовыеДоговора.ОкончаниеДоговора,"
	//Аверсон СВФР-014700
	
	//Аверсон ЕАЕ 22.12.2021 СВФР-008520
	+ ?(Организация.ИНН = "700067572", "
	|	ПодразделениеОрганизацииКод,
	|	ПодразделениеОрганизацииНаименование,","
	|	ПодразделениеОрганизацииКод,
	|	ПодразделениеОрганизацииНаименование,") + "
	//Аверсон СВФР-008520
	
	|	Сотрудник";
	
	Запрос.УстановитьПараметр("ДействиеТрудовогоДоговора",СписокТиповТрудовогоДоговора);
	Запрос.УстановитьПараметр("НачалоПериода",НачПериод);
	Запрос.УстановитьПараметр("ОкончаниеПериода",КонПериод);
	Запрос.УстановитьПараметр("Период",РабочаяДата);
	//О.Т. Аверсон 20.12.2015 № 765
	Если ЗначениеЗаполнено(ВидДоговора) Тогда 
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"//И ТрудовыеДоговора.ВидДоговора = &ВидДоговора","И ТрудовыеДоговора.ВидДоговора = &ВидДоговора");
	иначе
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"//И ТрудовыеДоговора.ВидДоговора = &ВидДоговора","");
	КонецЕсли;
	//О.Т. Аверсон 20.12.2015 № 765
	Запрос.УстановитьПараметр("ВидДоговора",ВидДоговора); //О.Т. Аверсон 20.12.2015 № 765
	
	//Запрос.УстановитьПараметр("ВидДоговора",Перечисления.ВидыДоговоровСФизЛицами.Контракт);
	Запрос.УстановитьПараметр("Подразделение",      Подразделение);
	Запрос.УстановитьПараметр("Организация",      Организация);
	
	Если Не Подразделение.Пустая() Тогда
		ТекстЗапроса = СтрЗаменить(ТекстЗапроса,"РаботникиОрганизацийСрезПоследних.Организация = &Организация","РаботникиОрганизацийСрезПоследних.ПодразделениеОрганизации В ИЕРАРХИИ (&Подразделение)")
	КонецЕсли;
	
	Запрос.Текст = ТекстЗапроса;
	
	Результат = Запрос.Выполнить();
	ТЗ = Результат.Выгрузить();	
	ДокументРезультат.Очистить();
	
	Область = мМакет.ПолучитьОбласть("Заголовок");
	Область.Параметры.Организация = Организация;	
	Область.Параметры.Период = ПредставлениеПериода(НачалоМесяца(НачПериод), КонецМесяца(КонПериод), "ДФ=""ММММ.гггг""");  //Аверсон 28.08.2019 КВВ СВФР-004690
	ДокументРезультат.Вывести(Область);
	
	//Параметры документа
	ДокументРезультат.ОриентацияСтраницы = ОриентацияСтраницы.Портрет;
	ДокументРезультат.ПолеСлева			 = 0;
	ДокументРезультат.ПолеСправа		 = 0;
	
	Область = мМакет.ПолучитьОбласть("Шапка");
	ДокументРезультат.Вывести(Область);
	
	ВыборкаИтог = Результат.Выбрать(ОбходРезультатаЗапроса.Прямой);
	
	мНомер = 0;
	ВывестиСтрокиПодразделения(ВыборкаИтог, ДокументРезультат);
	
КонецПроцедуры

//Аверсон ЕАЕ 26.08.2025 СВФР-016443
//Климовичи
//мМакет = ПолучитьМакет("МакетОтчета");
//Аверсон СВФР-016443

#КонецЕсли

