
Процедура ОбработкаПроведения(Отказ, РежимПроведения)
	МассивИндексыСтрокУдержания = Новый Массив();
	
	ВыборкаПоШапкеДокумента = СформироватьЗапросПоШапке().Выбрать();
	// позиционируем выборку
	ВыборкаПоШапкеДокумента.Следующий();
	ВыборкаПоУдержаниям = СформироватьЗапросПоУдержаниям().Выбрать();
	
	НаборУдержания = РегистрыРасчета.УправленческиеУдержания.СоздатьНаборЗаписей();
	НаборУдержания.Отбор.Регистратор.Значение = Ссылка;
	
	// заполним набор удержаний
	Пока ВыборкаПоУдержаниям.Следующий() Цикл 
		// проверим очередную строку табличной части
		ПроверитьЗаполнениеСтрокиУдержания(ВыборкаПоУдержаниям, Отказ);
		Если НЕ Отказ Тогда
			// Заполним записи в наборах записей регистров
			ДобавитьСтрокуУдержаний(ВыборкаПоУдержаниям, ВыборкаПоШапкеДокумента, НаборУдержания);
			МассивИндексыСтрокУдержания.Добавить(ВыборкаПоУдержаниям.НомерСтроки - 1); 
		КонецЕсли;
	КонецЦикла;

	Если Отказ Тогда
		Возврат;
	КонецЕсли;
	
	НаборУдержания.Записать(Истина);
КонецПроцедуры

// Формирует запрос по шапке документа
//
// Параметры: 
//  Нет
//
// Возвращаемое значение:
//  Результат запроса
//
Функция СформироватьЗапросПоШапке()

	Запрос = Новый Запрос;

	// Установим параметры запроса
	Запрос.УстановитьПараметр("ДокументСсылка" , Ссылка);

	Запрос.Текст =
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	УдержанияТелефон.Дата,
	|	УдержанияТелефон.Дата КАК ПериодРегистрации,
	//|	НачислениеЗарплатыРаботникам.ПоВременнойСхемеМотивации,
	//|	НачислениеЗарплатыРаботникам.ВидСхемыМотивации,
	//|	НачислениеЗарплатыРаботникам.ПоВременнойСхемеМотивации,
	|	УдержанияТелефон.Ссылка
	|ИЗ
	|	Документ.УдержанияТелефон КАК УдержанияТелефон
	|ГДЕ
	|	УдержанияТелефон.Ссылка = &ДокументСсылка";

	Возврат Запрос.Выполнить();

КонецФункции // СформироватьЗапросПоШапке()

// Формирует запрос по таблице "Удержания" документа
//
// Параметры: 
//  Физлицо
//
// Возвращаемое значение:
//  Результат запроса.
//
Функция СформироватьЗапросПоУдержаниям()

	Запрос = Новый Запрос;
	
	// Установим параметры запроса
	Запрос.УстановитьПараметр("ДокументСсылка", Ссылка);
	Запрос.УстановитьПараметр("Период", Дата);
	
	Запрос.Текст = 
	"ВЫБРАТЬ РАЗРЕШЕННЫЕ
	|	СтрокиУдержания.ВидУдержания КАК ВидРасчета,
	|	НАЧАЛОПЕРИОДА(СтрокиУдержания.Ссылка.Дата, Месяц) КАК ДатаНачала,
	|	КОНЕЦПЕРИОДА(СтрокиУдержания.Ссылка.Дата, Месяц) КАК ДатаОкончания,
	|	СтрокиУдержания.НомерСтроки КАК НомерСтроки,
	|	СтрокиУдержания.СуммаУдержания КАК Результат,
	|	ЕстьNull(СоответствиеПодразделенийИПодразделенийОрганизаций.Подразделение, ЗНАЧЕНИЕ(Справочник.Подразделения.ПустаяСсылка)) КАК Подразделение,
	|	СтрокиУдержания.Сотрудник.Физлицо КАК ФизЛицо,
	|   СтрокиУдержания.Сотрудник     
	//|	СтрокиУдержания.Показатель1,
	//|	СтрокиУдержания.Показатель2,
	//|	СтрокиУдержания.Показатель3,
	//|	СтрокиУдержания.Показатель4,
	//|	СтрокиУдержания.Показатель5,
	//|	СтрокиУдержания.Показатель6,	
	//|	СтрокиУдержания.Авторасчет КАК Авторасчет
	|ИЗ
	|	Документ.УдержанияТелефон.Удержания КАК СтрокиУдержания
	|ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.РаботникиОрганизаций.СрезПоследних(&Период) КАК РаботникиОрганизаций
	|   ЛЕВОЕ СОЕДИНЕНИЕ РегистрСведений.СоответствиеПодразделенийИПодразделенийОрганизаций КАК СоответствиеПодразделенийИПодразделенийОрганизаций
	|   ПО РаботникиОрганизаций.ПодразделениеОрганизации = СоответствиеПодразделенийИПодразделенийОрганизаций.ПодразделениеОрганизации
	|ПО СтрокиУдержания.Сотрудник = РаботникиОрганизаций.Сотрудник
	|ГДЕ
	|	СтрокиУдержания.Ссылка = &ДокументСсылка
	|
	|УПОРЯДОЧИТЬ ПО
	|	НомерСтроки";
	
	Возврат Запрос.Выполнить();

КонецФункции // СформироватьЗапросПоУдержания()

// Проверяет правильность заполнения реквизитов в строке ТЧ "Удержания" документа.
// Если какой-то из реквизтов, влияющий на проведение, не заполнен или
// заполнен некорректно, то выставляется флаг отказа в проведении.
// Проверка выполняется по выборке из результата запроса к ТЧ документа,
// все проверяемые реквизиты должны быть включены в выборку.
//
// Параметры: 
//  ВыборкаПоСтрокамДокумента	- спозиционированная на определеной строке выборка 
//  							  из результата запроса к ТЧ документа, 
//  Отказ 						- флаг отказа в проведении.
//	Заголовок					- Заголовок для сообщений об ошибках проведения
//
Процедура ПроверитьЗаполнениеСтрокиУдержания(ВыборкаПоСтрокамДокумента, Отказ, Заголовок = "")

	СтрокаНачалаСообщенияОбОшибке = "В строке номер """+ СокрЛП(ВыборкаПоСтрокамДокумента.НомерСтроки) +
									""" табл. части ""Удержания"": ";
	
	// Физлицо
	Если Не ЗначениеЗаполнено(ВыборкаПоСтрокамДокумента.Сотрудник) Тогда
		ОбщегоНазначения.СообщитьОбОшибке(СтрокаНачалаСообщенияОбОшибке + "не выбран Сотрудник!", Отказ, Заголовок);
	КонецЕсли;

	//// ВидРасчета
	//Если НЕ ЗначениеЗаполнено(ВыборкаПоСтрокамДокумента.ВидРасчета) Тогда
	//	ОбщегоНазначения.СообщитьОбОшибке(СтрокаНачалаСообщенияОбОшибке + "не указан вид расчета!", Отказ, Заголовок);
	//КонецЕсли;

	// Дата начала
	//Если НЕ ЗначениеЗаполнено(ВыборкаПоСтрокамДокумента.ДатаНачала) Тогда
	//	ОбщегоНазначения.СообщитьОбОшибке(СтрокаНачалаСообщенияОбОшибке + "не указана дата начала удержания!", Отказ, Заголовок);
	//КонецЕсли;

	//// Дата окончания
	//Если Не ЗначениеЗаполнено(ВыборкаПоСтрокамДокумента.ДатаОкончания) Тогда
	//	ОбщегоНазначения.СообщитьОбОшибке(СтрокаНачалаСообщенияОбОшибке + "не указана дата окончания удержания!", Отказ, Заголовок);
	//КонецЕсли;

	
КонецПроцедуры // ПроверитьЗаполнениеСтрокиУдержания()

// По строке выборок из результатов запроса по документу формируем движения по регистрам
//
// Параметры: 
//  ВыборкаПоСтрокамДокумента				- спозиционированная на определеной строке выборка 
//				  							  из результата запроса к ТЧ документа, 
//	ВыборкаПоШапкеДокумента
//
// Возвращаемое значение:
//  Нет.
//
Процедура ДобавитьСтрокуУдержаний(ВыборкаПоСтрокамДокумента, ВыборкаПоШапкеДокумента, НаборУдержания)	

	Движение = НаборУдержания.Добавить();

	// Свойства
	Движение.ПериодРегистрации			= ВыборкаПоШапкеДокумента.ПериодРегистрации;
	Движение.БазовыйПериодНачало		= ВыборкаПоСтрокамДокумента.ДатаНачала;
	Движение.БазовыйПериодКонец			= ВыборкаПоСтрокамДокумента.ДатаОкончания;
	Движение.ВидРасчета					= ВыборкаПоСтрокамДокумента.ВидРасчета;
	Движение.Подразделение              = ВыборкаПоСтрокамДокумента.Подразделение;

	// Измерения
	Движение.Физлицо					= ВыборкаПоСтрокамДокумента.Физлицо;
	//Движение.ВидСхемыМотивации			= ВыборкаПоШапкеДокумента.ВидСхемыМотивации; ???	
	

	// Ресурсы
	Движение.Результат					= ВыборкаПоСтрокамДокумента.Результат;

	// Реквизиты
	//Движение.Показатель1				= ВыборкаПоСтрокамДокумента.Показатель1;???
	//Движение.Показатель2				= ВыборкаПоСтрокамДокумента.Показатель2;???
	//Движение.Показатель3				= ВыборкаПоСтрокамДокумента.Показатель3; ???
	//Движение.Показатель4				= ВыборкаПоСтрокамДокумента.Показатель4;???
	//Движение.Показатель5				= ВыборкаПоСтрокамДокумента.Показатель5;???
	//Движение.Показатель6				= ВыборкаПоСтрокамДокумента.Показатель6;???	
	//Движение.Авторасчет					= ВыборкаПоСтрокамДокумента.Авторасчет;
	//Движение.ПоВременнойСхемеМотивации	= ВыборкаПоШапкеДокумента.ПоВременнойСхемеМотивации;

КонецПроцедуры // ДобавитьСтрокуУдержаний
